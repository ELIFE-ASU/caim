<!DOCTYPE html><html lang="en"><head><title>main</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="main"><meta name="groc-project-path" content="main.js"><meta name="groc-github-url" content="https://github.com/dglmoore/caim"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/dglmoore/caim/blob/master/main.js">main.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Copyright 2018. Douglas G. Moore. All rights reserved.</p>
<p>Use of this source code is governed by the MIT license that can be found in
the LICENSE file.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="the-caim-ui">The Caim UI</h1>
<p>Caim&#39;s UI is built on <a href="https://electronjs.org">electron</a>. This design
decision was based on two factors:</p>
<ol>
<li>Electron is a reasonable cross-platform UI toolkit</li>
<li>It is 100% Javascript + HTML + CSS</li>
</ol>
<p>The original version of <a href="https://github.com/elife-asu/caim-go">caim</a> was
written using a Server + Client architecture, with the front-end implemented
with the standard web technologies. The hope is that this will make porting
caim to a standalone application using electron fairly straitforward.</p>
<p>To start, I get <code>app</code>, <code>dialog</code>, <code>BrowserWindow</code> and <code>Menu</code> from electron.
The former will be our application object, and I&#39;ll use the latter to create
windows.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">const</span> {app, dialog, BrowserWindow, Menu} = <span class="hljs-built_in">require</span>(<span class="hljs-string">'electron'</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="creating-windows">Creating Windows</h2>
<p>I then need to create a global variable to keep track of our active window.
Caim is to be designed as a single-window application, so I don&#39;t need <code>win</code>
to be an array.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">let</span> win = <span class="hljs-literal">null</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>From here I define a <code>create_window</code> function will will take care of
building a new Caim window.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create_window</span>(<span class="hljs-params"></span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This entails initializing <code>win</code> with a new <code>BrowserWindow</code>.</p></div></div><div class="code"><div class="wrapper">    win = <span class="hljs-keyword">new</span> BrowserWindow();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Now that we have a window, I need to setup it&#39;s menu.  It consists of
the following menu items:</p>
<ol>
<li>File<ul>
<li>New Session</li>
<li>Import Video</li>
<li>Quit</li>
</ul>
</li>
<li>View<ul>
<li>Fullscreen</li>
</ul>
</li>
</ol></div></div><div class="code"><div class="wrapper">    Menu.setApplicationMenu(<span class="hljs-keyword">new</span> Menu.buildFromTemplate([
        {
            label: <span class="hljs-string">'File'</span>,
            submenu: [
                {
                    label: <span class="hljs-string">'New Session'</span>,
                    id: <span class="hljs-string">'new-session'</span>,
                    click: new_session_dialog
                },
                {
                    label: <span class="hljs-string">'Import Video'</span>,
                    id: <span class="hljs-string">'import-video'</span>,
                    enabled: <span class="hljs-literal">false</span>
                },
                {
                    label: <span class="hljs-string">'Quit'</span>,
                    id: <span class="hljs-string">'quit'</span>,
                    role: <span class="hljs-string">'quit'</span>
                }
            ]
        },
        {
            label: <span class="hljs-string">'View'</span>,
            submenu: [
                {
                    label: <span class="hljs-string">'Fullscreen'</span>,
                    id: <span class="hljs-string">'fullscreen'</span>,
                    role: <span class="hljs-string">'toggleFullScreen'</span>
                }
            ]
        }
    ]));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The primary UI is provided in the <code>assets/startup.html</code> directory. To
load it, I simply pass the path to the <code>loadFile</code> method of <code>win</code>.</p></div></div><div class="code"><div class="wrapper">    win.loadFile(<span class="hljs-string">'assets/startup.html'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>I then register an <code>onclosed</code> event handler which sets our <code>win</code>
variable to <code>null</code> so it can be garbage collected.</p></div></div><div class="code"><div class="wrapper">    win.on(<span class="hljs-string">'closed'</span>, () =&gt; win = <span class="hljs-literal">null</span>);
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="handling-app-events">Handling App Events</h2>
<p>I create a window in response two events:</p>
<ol>
<li>when the app&#39;s <code>&#39;ready&#39;</code> event fires</li>
<li>when the application becomes activated and there is no window.</li>
</ol></div></div><div class="code"><div class="wrapper">app.on(<span class="hljs-string">'ready'</span>, create_window);

app.on(<span class="hljs-string">'activate'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (win === <span class="hljs-literal">null</span>) {
        create_window();
    }
});</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Finally, we quit the app if when the last window is close.</p>
<p><strong>Note</strong>: it is OS X standard operating procedure to keep the application
running after the last window is closed. Users have to explictly quit the
application.</p></div></div><div class="code"><div class="wrapper">app.on(<span class="hljs-string">'window-all-closed'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (process.platform !== <span class="hljs-string">'darwin'</span>) {
        app.quit();
    }
});</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="handling-menu-events">Handling Menu Events</h2>
<p>I need to be able to create new sessions, load old sessions, etc... That is
all handled via the menu. Each menu item, then, needs an associated event
handler.</p>
<p>I started with the <code>File -&gt; New Session</code> menu item, and created the
<code>new_session_dialog</code> handler. It starts a <code>dialog.showOpenDialog</code> allowing
the user to select a directory.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new_session_dialog</span>(<span class="hljs-params">menuItem, browserWindow, event</span>) </span>{
    dialog.showOpenDialog(browserWindow, {
        title: <span class="hljs-string">'Choose New Session Directory'</span>,
        properties: [
            <span class="hljs-string">'openDirectory'</span>,
            <span class="hljs-string">'createDirectory'</span>,
            <span class="hljs-string">'promptToCreate'</span>
        ]
    }, new_session);
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The resulting paths are then passed to the <code>new_session</code> function.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new_session</span>(<span class="hljs-params">session_path</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>I first ensure that the user made a selection.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (session_path !== <span class="hljs-literal">undefined</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Since a session must exist in a single directory,
I also make sure they&#39;ve only selected one path.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> (session_path.length !== <span class="hljs-number">1</span>) {
            new_session_error({
                message: <span class="hljs-string">'Too many paths selected, select only one'</span>
            });
            <span class="hljs-keyword">return</span>;
        }
        session_path = session_path[<span class="hljs-number">0</span>];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>I can then create the session directory if it doesn&#39;t exit, display
an error if it isn&#39;t a directory, or display an error if it isn&#39;t
empty.</p></div></div><div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> (!fs.existsSync(session_path)) {
            fs.mkdirSync(session_path);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!fs.statSync(session_path).isDirectory()) {
            new_session_error({
                message: <span class="hljs-string">`Requested session path (<span class="hljs-subst">${session_path}</span>) is not a directory`</span>,
                detail: <span class="hljs-string">'Please report this error the maintainer Douglas G. Moore &lt;doug@dglmoore.com&gt;'</span>,
            });
            <span class="hljs-keyword">return</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fs.readdirSync(session_path).length != <span class="hljs-number">0</span>) {
            new_session_error({
                message: <span class="hljs-string">`Requested session path (<span class="hljs-subst">${session_path}</span>) is not empty`</span>,
            });
            <span class="hljs-keyword">return</span>;
        }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>I then load the <code>assets/session.html</code> page into the UI.</p></div></div><div class="code"><div class="wrapper">        win.loadFile(<span class="hljs-string">"assets/session.html"</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Finally, I enable the <code>File -&gt; Import Video</code> menu item.</p></div></div><div class="code"><div class="wrapper">        app.getApplicationMenu().getMenuItemById(<span class="hljs-string">'import-video'</span>).enabled = <span class="hljs-literal">true</span>;
    }
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="error-dialogs">Error Dialogs</h2>
<p>Errors are likely time a program has to interact with humans. I need to be
able to easily report errors, in the form of dialog messages, to the users.</p>
<p>Our first such message dialog is opened whenever an error occurs within the
<code>new_session</code> function.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new_session_error</span>(<span class="hljs-params">options</span>) </span>{
    options = <span class="hljs-built_in">Object</span>.assign({
        type: <span class="hljs-string">'error'</span>,
        title: <span class="hljs-string">'New Session Error'</span>,
        buttons: [<span class="hljs-string">'OK'</span>]
    }, options);

    dialog.showMessageBox(options);
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="conclusion">Conclusion</h2>
<p>That&#39;s all we need to create a basic UI with electron. As we develop the
project further, we&#39;ll need to extend electron&#39;s base menus with options for
loading videos and reloading sessions, but this is good for now.</p></div></div></div></div></body></html>